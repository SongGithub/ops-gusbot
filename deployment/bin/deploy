#!/usr/bin/env bash
environment="${ENVIRONMENT:?Need to set ENVIRONMENT}"
application_image="${APPLICATION_IMAGE:?Need to set APPLICATION_IMAGE}"
application_version="${APPLICATION_VERSION:?Need to set APPLICATION_VERSION}"

dcr="docker-compose -f deployment/docker-compose.yml"

$dcr pull

$dcr run kubectl apply -f deployment/$environment/environment.yml

$dcr run ktmpl deployment/application.yml \
    --parameter APPLICATION_IMAGE $application_image:$application_version \
    --parameter APPLICATION_VERSION $application_version \
    --parameter-file deployment/$environment/application-params.yml | $dcr run kubectl apply -f -

$dcr run kubectl rollout status -w deployment/gusbot -n platform-enablement
